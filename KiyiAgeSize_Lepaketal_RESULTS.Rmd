---
output: word_document
---
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
## Read helper code
source("code/aaaInit.R")
## Set random seed ... bootstraps and ALKs will be the same each time
set.seed(34783475)

## Show intermediate results or not
show.res <- 'hide'  # 'markup' or 'hide'
show.msg <- ifelse(show.res=='hide',FALSE,TRUE)
## Make plots upon knitting
makePlots <- TRUE
```

```{r echo=FALSE, results='hide'}
## Load and manipulate the length-frequency data from 2014.
lf14 <- read.csv("data/clean/lenfreq_2014.csv") %>%
  mutate(region=factor(region,levels=regS),
         regionL=factor(regionL,levels=regL),
         year=factor(year),
         mon=factor(mon,levels=c("May","Jun","Jul")))
# basic length summary of the entire sample
lf14_sum <- Summarize(~tl,data=lf14)
# basic length summary by region
lf14_reg <- Summarize(tl~region,data=lf14,digits=1)
# months when Kiyi were collected
lf14_mons <- xtabs(~mon,data=lf14)
# locations where Kiyi were collected
lf14_locs <- xtabs(~location,data=lf14)
```

```{r echo=FALSE, results=show.res, fig.show='hide', message=show.msg}
##  Examine Length Frequency by Region (for 2014)
# Split by region for comparisons below
lf14_west  <- filterD(lf14,region=="West") %>% as.data.frame()
lf14_nomich  <- filterD(lf14,region=="NoMich") %>% as.data.frame()
lf14_noont <- filterD(lf14,region=="NoOnt") %>% as.data.frame()
lf14_soont <- filterD(lf14,region=="SoOnt") %>% as.data.frame()
lf14_emich  <- filterD(lf14,region=="EastMich") %>% as.data.frame()

# pairwise bootstrapped Kolmogorov-Smirnov tests
nboots <- 2500
ks.pvals <- c(ks.boot(lf14_west$tl,lf14_nomich$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_west$tl,lf14_noont$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_west$tl,lf14_soont$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_west$tl,lf14_emich$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_nomich$tl,lf14_noont$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_nomich$tl,lf14_soont$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_nomich$tl,lf14_emich$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_noont$tl,lf14_soont$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_noont$tl,lf14_emich$tl,nboots=nboots)$ks.boot.pvalue,
              ks.boot(lf14_soont$tl,lf14_emich$tl,nboots=nboots)$ks.boot.pvalue)
ks_res <- data.frame(comparisons=apply(combn(regL,2),MARGIN=2,FUN=paste,
                                       collapse=" v. "),adj.pval=p.adjust(ks.pvals))
ks_max.sig.p <- max(ks_res$adj.pval[which(ks_res$adj.pval<0.05)])
ks_min.nsig.p <- min(ks_res$adj.pval[which(ks_res$adj.pval>0.05)])

cat("Summary of Kolmogorov-Smirnov Tests")
ks_res

# ECDF plots -- NOT IN MANUSCRIPT
ggplot(lf14,aes(tl,color=region)) +
  theme_kiyi() +
  geom_line(stat="ecdf",size=1.25) +
  labs(x="Total Length (mm)",y="Cumulative Density") +
  scale_color_manual(values=clrs)
```
```{r echo=FALSE, results=show.res, message=show.msg}
## ANOVA for tl (for 2014)
lf14_levtest <- leveneTest(tl~region,data=lf14)
lf14_aov.lm <- lm(tl~region,data=lf14)
lf14_aov <- anova(lf14_aov.lm)
lf14_mc <- glht(lf14_aov.lm,mcp(region="Tukey"))
lf14_smc <- summary(lf14_mc)
lf14_smc_max.sig.p <- max(lf14_smc$test$pvalues[which(lf14_smc$test$pvalues<0.05)])
lf14_siglets <- cld(lf14_mc)$mcletters$Letters

res_tlaov <- cbind(Summarize(tl~region,data=lf14,digits=1),siglets=lf14_siglets[regS])

## Kruskal-Wallis for tl -- NOT IN MANUSCRIPT
lf14_kwt <- kruskal.test(tl~region,data=lf14)
lf14_kwt.mc <- dunnTest(tl~region,data=lf14)
```

```{r echo=FALSE, results='hide'}
## Load the Biological Data (for 2014)
bio <- read.csv("data/clean/bio.csv") %>%
  mutate(region=factor(region,levels=regS),
         regionL=factor(regionL,levels=regL),
         sex=factor(sex,levels=c("juvenile","female","male")))

# sex ratio summary of the subsample
sex_freq <- xtabs(~sex,data=bio)
sex_freq2 <- xtabs(~sex,data=filterD(bio,sex!="juvenile"))
sex_perc2 <- prop.table(sex_freq2)*100

# maturity summary of the non-juvenile subsample
mat_freq <- xtabs(~sex+mat,data=filterD(bio,sex!="juvenile"))
mat_sum <- Summarize(tl~sex,data=filterD(bio,sex!="juvenile",mat=="mature"))
immat_sum <- Summarize(tl~sex,data=filterD(bio,sex!="juvenile",mat=="immature"))

# TL summary of the non-juvenile subsample
tl_sum <- Summarize(tl~sex,data=filterD(bio,sex!="juvenile"))
```

A total of `r formatC(lf14_sum[["n"]],format="f",digits=0)` Kiyi were collected at `r length(lf14_locs)` of the 102 locations sampled in 2014 (Figure 1).  Kiyi were found at one station on 27 May 2014, at two stations on 5 June 2014, and at 21 stations between 7 July and 20 July 2014.  Biomass and density ranged from 0-12 $kg \cdot ha^{-1}$ and 0-253 $fish \cdot ha^{-1}$, respectively.  Based on collections made at 22 on-contour sampling locations, the minimum and maximum depth of capture were 132 and 256 m.  Maximum density (253 $fish \cdot ha^{-1}$) and biomass (12  $kg \cdot ha^{-1}$) were observed at 190 m.  Bottom water temperatures at sites where Kiyi were collected ranged from 2.8-$3.9^{o}$C with a mean of $3.5^{o}$C.

The lengths of collected Kiyi were between `r formatC(lf14_sum[["min"]],format="f",digits=0)` and `r formatC(lf14_sum[["max"]],format="f",digits=0)` mm TL with a mean (SD) TL of `r formatC(lf14_sum[["mean"]],format="f",digits=0)` (`r formatC(lf14_sum[["sd"]],format="f",digits=1)`) mm.  The length distribution of Kiyi from the Northern Ontario region differed significantly from the length distributions of Kiyi captured from all other regions (p < `r kPvalue(ks_max.sig.p,digits=3,include.p=FALSE)`), which did not differ (p > `r kPvalue(ks_min.nsig.p,digits=3,include.p=FALSE)`).  The Northern Ontario region had fewer longer fish, which resulted in a significantly shorter mean TL (p < `r kPvalue(lf14_smc_max.sig.p,digits=3,include.p=FALSE)`; Figure 2).

In the (sex- and length-stratified) subsample of `r sum(sex_freq)` fish, `r kCounts(sex_freq["juvenile"])` were juveniles and `r formatC(sex_perc2["female"],format="f",digits=1)`% of non-juvenile fish were female.  Only `r mat_freq["female","immature"]` female (`r formatC(immat_sum[1,"min"],format="f",digits=0)` mm) and `r mat_freq["male","immature"]` males in the subsample were sexually immature.  The largest male that was sexually mature was `r formatC(immat_sum[2,"max"],format="f",digits=0)` mm.  The smallest sexually mature fish in the subsample were a `r formatC(mat_sum[1,"min"],format="f",digits=0)` mm female and a `r formatC(mat_sum[2,"min"],format="f",digits=0)` mm male.

The examination of length frequencies from 2001 through 2014 revealed distinct modes near 80-100 mm in 2004, 2006, and 2010 (Figure 3).  These modes corresponded to age-1 fish as Kiyi likely hatch at a size (10-12 mm) and time (early spring) similar to Cisco (Oyadomari and Auer, 2007; Oyadomari and Auer, 2008) and reached a mean length of approximately 100 mm by the following spring in Lake Michigan (Tables 8 and 9 in Deason and Hile 1947).  Thus, these cohorts corresponded to ages 11, 9, and 5, respectively, in 2014.  There was little evidence for the 2005 cohort in 2007 which suggests that few age-9 fish may exist in 2014.

```{r echo=FALSE, results='hide'}
# summary of the otolith characteristics
( octbl <- xtabs(~otoChar,data=bio) )
# find proportion unuseable
octbl_perc <- prop.table(octbl)*100
# find proportion of useable that were unreadable
octbl2 <- octbl[-2]
octbl2_perc <- prop.table(octbl2)*100
# Age frequency by sex (for use in discussion)
xtabs(~sex+otoAge,data=filterD(bio,otoChar=="USEABLE"))
```
```{r echo=FALSE, results=show.res, message=show.msg}
cat("Between-reader otolith comparisons (TAL v. DHO ages)")
bio_OO <- filterD(bio,otoChar=="USEABLE")

ab_OO <- ageBias(otoAge_TAL~otoAge_DHO,data=bio_OO,
                 ref.lab="Ager 1",nref.lab="Ager 2")
ab_OO_bsum <- summary(ab_OO,what="bias")
ab_OO_bsym <- summary(ab_OO,what="symmetry")
ap_OO <- agePrecision(otoAge_TAL~otoAge_DHO,data=bio_OO)
ap_OO_psum <- summary(ap_OO,what="precision")
( ap_OO_pdiff <- summary(ap_OO,what="absolute difference") )
( ap_OO_pdiff1 <- summary(ap_OO,what="absolute difference",trunc.diff=2) )
```

```{r echo=FALSE, results=show.res, message=show.msg}
cat("Otolith-scales comparisons (only TAL ages)")
bio_OS <- bio[complete.cases(bio[,c("scaleAge","otoAge_TAL")]),]
ab_OS <- ageBias(scaleAge~otoAge_TAL,data=bio_OS,
                 ref.lab="Otolith Age",nref.lab="Scale Age")
ab_OS_bsum <- summary(ab_OS,what="bias")
ab_OS_bsym <- summary(ab_OS,what="symmetry")
```

Ages were estimated by two readers from `r sum(octbl2)` thin-sectioned otoliths.  Of these otoliths, `r octbl2["UNREADABLE"]` (`r formatC(octbl2_perc["UNREADABLE"],format="f",digits=1)`%) were deemed unreadable (cracked or cloudy image) and were removed from further consideration.  Ages estimated from the two readers perfectly agreed for `r formatC(ap_OO_pdiff1[["0"]],format="f",digits=1)`% of the otoliths, agreed within one year for `r formatC(100-ap_OO_pdiff1[["2+"]],format="f",digits=1)`% of the otoliths, had a between-reader ACV of `r formatC(ap_OO_psum[["ACV"]],format="f",digits=1)`, and showed no significant systematic bias (`r kPvalue(ab_OO_bsym[2,"p"],digits=3)`; Figure 4).  However, the mean estimated age for the second reader was slightly greater when the first reader estimated an age of 5 (95% CI: `r formatC(ab_OO_bsum[2,"LCI"],format="f",digits=1)`-`r formatC(ab_OO_bsum[2,"UCI"],format="f",digits=1)`; `r kPvalue(ab_OO_bsum[2,"adj.p"],digits=3)`) and slightly lower when the first reader estimated an age of 12 (95% CI: `r formatC(ab_OO_bsum[9,"LCI"],format="f",digits=1)`-`r formatC(ab_OO_bsum[9,"UCI"],format="f",digits=1)`; `r kPvalue(ab_OO_bsum[9,"adj.p"],digits=3)`).  Mean scale age for each otolith age was less than the otolith age for all observed otolith ages with adequate sample sizes (p < `r kPvalue(max(ab_OS_bsum[,"adj.p"],na.rm=TRUE),digits=3,include.p=FALSE)`; Figure 5).  The maximum observed age was `r max(bio$otoAge,na.rm=TRUE)` when otoliths were used, but only `r max(bio$scaleAge,na.rm=TRUE)` when scales were used.

```{r echo=FALSE, results=show.res, message=show.msg}
# Remove juvenile fish (same as removing all fish <140 mm)
#   and those without otoages
bio_ALK <- filterD(bio,sex!="juvenile",!is.na(otoAge))
# age frequency
( bio_ALK_agefreq <- xtabs(~otoAge,data=bio_ALK) )
# Remove age-13 and older fish for the statistical comparisons
#   as they are poorly represented in the sample
bio_ALK2 <- filterD(bio_ALK,otoAge<13)
bio_alk_numremoved <- nrow(bio_ALK)-nrow(bio_ALK2)

## Create region-specific data
West  <- filterD(bio_ALK2,region=="West")
NoMich  <- filterD(bio_ALK2,region=="NoMich")
NoOnt <- filterD(bio_ALK2,region=="NoOnt")
SoOnt <- filterD(bio_ALK2,region=="SoOnt")
EastMich  <- filterD(bio_ALK2,region=="EastMich")

## ALK comparisons by sex within regions
west1 <- multinom(otoAge~lcat10,data=West,maxit=500)
west2 <- multinom(otoAge~lcat10*sex,data=West,maxit=500)
alkcomp_WA <- anova(west1,west2)
NoMich1 <- multinom(otoAge~lcat10,data=NoMich,maxit=500)
NoMich2 <- multinom(otoAge~lcat10*sex,data=NoMich,maxit=500)
alkcomp_NM <- anova(NoMich1,NoMich2)
NoOnt1 <- multinom(otoAge~lcat10,data=NoOnt,maxit=500)
NoOnt2 <- multinom(otoAge~lcat10*sex,data=NoOnt,maxit=500)
alkcomp_NO <- anova(NoOnt1,NoOnt2)
SoOnt1 <- multinom(otoAge~lcat10,data=SoOnt,maxit=500)
SoOnt2 <- multinom(otoAge~lcat10*sex,data=SoOnt,maxit=500)
alkcomp_SO <- anova(SoOnt1,SoOnt2)
EastMich1 <- multinom(otoAge~lcat10,data=EastMich,maxit=500)
EastMich2 <- multinom(otoAge~lcat10*sex,data=EastMich,maxit=500)
alkcomp_EM <- anova(EastMich1,EastMich2)

# Sexes combined across all regions
mod1 <- multinom(otoAge~lcat10,data=bio_ALK2,maxit=500)
mod2 <- multinom(otoAge~lcat10*sex,data=bio_ALK2,maxit=500)
alkcomp_sex <- anova(mod1,mod2)

## ALK comparisons by regions (sexes pooled)
mod3 <- multinom(otoAge~lcat10,data=bio_ALK2,maxit=500)
mod4 <- multinom(otoAge~lcat10*region,data=bio_ALK2,maxit=500)
alkcomp_reg <- anova(mod3,mod4)

## Table of all ALK comparisons results
alkcomp_res <- data.frame(Comparison=c(paste("By sex within",regS),
                                       "By sex, Pooled regions",
                                       "By region, Pooled sexes"),
           df1   =c(alkcomp_WA$'   Df'[2],
                    alkcomp_NM$'   Df'[2],
                    alkcomp_NO$'   Df'[2],
                    alkcomp_SO$'   Df'[2],
                    alkcomp_EM$'   Df'[2],
                    alkcomp_sex$'   Df'[2],
                    alkcomp_reg$'   Df'[2]),
           df2   =c(alkcomp_WA$'Resid. df'[2],
                    alkcomp_NM$'Resid. df'[2],
                    alkcomp_NO$'Resid. df'[2],
                    alkcomp_SO$'Resid. df'[2],
                    alkcomp_EM$'Resid. df'[2],
                    alkcomp_sex$'Resid. df'[2],
                    alkcomp_reg$'Resid. df'[2]),
           pvalue=c(alkcomp_WA$'Pr(Chi)'[2],
                    alkcomp_NM$'Pr(Chi)'[2],
                    alkcomp_NO$'Pr(Chi)'[2],
                    alkcomp_SO$'Pr(Chi)'[2],
                    alkcomp_EM$'Pr(Chi)'[2],
                    alkcomp_sex$'Pr(Chi)'[2],
                    alkcomp_reg$'Pr(Chi)'[2]))
alkcomp_res
```
```{r echo=FALSE, results=show.res, message=show.msg}
# Get raw LF 2014 data, restrict to fish >= 140 mm, and add an
# otoAge variable to record the new ages
lf14_ages <- lf14 %>%
  mutate(otoAge=as.numeric(NA)) %>%
  filter(tl>=140) %>%
  as.data.frame()
```

Kiyi for which a consensus otolith age estimate was obtained were used to generate ALKs.  Four Kiyi less than 140 mm TL (all of the juvenile fish) were excluded from all ALK analyses because of sample size considerations.  An additional `r kCounts(bio_alk_numremoved)` fish that were estimated to be age-13 or older were also removed from the analysis that compared ALKs among regions because of sample size considerations.  Age-length keys did not differ significantly between sexes within any region (p > `r kPvalue(min(alkcomp_res$pvalue[1:5]),digits=3,include.p=FALSE)`) or among regions when sexes were pooled (`r kPvalue(alkcomp_res$pvalue[7],digits=3)`).  Despite this finding, to minimize the loss of any regional differences in the relationship between age and length, region-specific observed age-length keys were generated and used to assign ages by region to the `r nrow(lf14_ages)` sampled Kiyi that were longer than 140 mm.

```{r echo=FALSE, results=show.res, message=show.msg, warning=FALSE}
## Create region-specific data
West  <- filterD(bio_ALK,region=="West")
NoMich  <- filterD(bio_ALK,region=="NoMich")
NoOnt <- filterD(bio_ALK,region=="NoOnt")
SoOnt <- filterD(bio_ALK,region=="SoOnt")
EastMich  <- filterD(bio_ALK,region=="EastMich")

## Construct separate ALKs
West.aged  <- West  %>% filterD(!is.na(otoAge)) %>% as.data.frame()
NoMich.aged  <- NoMich  %>% filterD(!is.na(otoAge)) %>% as.data.frame()
NoOnt.aged <- NoOnt %>% filterD(!is.na(otoAge)) %>% as.data.frame()
SoOnt.aged <- SoOnt %>% filterD(!is.na(otoAge)) %>% as.data.frame()
EastMich.aged  <- EastMich  %>% filterD(!is.na(otoAge)) %>% as.data.frame()

West.alk  <- prop.table(xtabs(~lcat10+otoAge,data=West.aged),margin=1)
NoMich.alk  <- prop.table(xtabs(~lcat10+otoAge,data=NoMich.aged),margin=1)
NoOnt.alk <- prop.table(xtabs(~lcat10+otoAge,data=NoOnt.aged),margin=1)
SoOnt.alk <- prop.table(xtabs(~lcat10+otoAge,data=SoOnt.aged),margin=1)
# assumed that 140 and 150 bins were the same as 160 bin for
# applying the ALK below
SoOnt.alk <- rbind(SoOnt.alk[c(1,1),],SoOnt.alk)
rownames(SoOnt.alk)[1:2] <- c(140,150)
EastMich.alk  <- prop.table(xtabs(~lcat10+otoAge,data=EastMich.aged),margin=1)

## Apply the age-length keys
# get the unaged fish from the length frequency data.frame
West.unaged   <- filterD(lf14_ages,region=="West")
NoMich.unaged   <- filterD(lf14_ages,region=="NoMich")
NoOnt.unaged  <- filterD(lf14_ages,region=="NoOnt")
SoOnt.unaged  <- filterD(lf14_ages,region=="SoOnt")
EastMich.unaged   <- filterD(lf14_ages,region=="EastMich")
# apply the ALKS
West.unaged.mod  <- alkIndivAge(West.alk,otoAge~tl,data=West.unaged)
NoMich.unaged.mod  <- alkIndivAge(NoMich.alk,otoAge~tl,data=NoMich.unaged)
NoOnt.unaged.mod <- alkIndivAge(NoOnt.alk,otoAge~tl,data=NoOnt.unaged)
SoOnt.unaged.mod <- alkIndivAge(SoOnt.alk,otoAge~tl,data=SoOnt.unaged)
EastMich.unaged.mod  <- alkIndivAge(EastMich.alk,otoAge~tl,data=EastMich.unaged)

## Put all of the data.frames together to make one with all aged fish
lf14_ages <- rbind(West.unaged.mod,NoMich.unaged.mod,NoOnt.unaged.mod,
                   SoOnt.unaged.mod,EastMich.unaged.mod)
any(is.na(lf14_ages$otoAge))     # confirm FALSE
```
```{r echo=FALSE, results=show.res, messages=show.res, warning=FALSE}
# Age frequency tables by region (sexes pooled)
#   with corresponding chi-square tests
( age_freq1 <- xtabs(~region+otoAge,data=lf14_ages) )
# Made ages <6,6,7,8,9,10,11,>11 in groups
age_freq2 <- cbind(rowSums(age_freq1[,1:2]),age_freq1[,3:8],rowSums(age_freq1[,9:13]))
colnames(age_freq2)[c(1,ncol(age_freq2))] <- c("<6",">11")
# Made ages <6,6,7,8,9,10,11,>11 in groups
( OA.chi <- chisq.test(age_freq2) )
```
```{r echo=FALSE, message=show.msg, results=show.res}
res_ageaov <- Summarize(otoAge~region,data=lf14_ages,digits=1)
ageaov <- lm(otoAge~region,data=lf14_ages)
agemc <- summary(glht(ageaov,mcp(region="Tukey")))
res_ageaov <- cbind(res_ageaov,siglets=cld(agemc)$mcletters$Letters)
ageperc <- prop.table(xtabs(~region+otoAge,data=lf14_ages),margin=1)*100
res_ageaov <- cbind(res_ageaov,round(ageperc[,c("5","6","11")],0))
names(res_ageaov)[13:15] <- paste0("%age-",names(res_ageaov)[13:15])

Summarize(~otoAge,data=lf14_ages,digits=1)
round(prop.table(xtabs(~otoAge,data=lf14_ages))*100,0)
```

The age distribution (Figure 6; Table 1) was bimodal in each region with an upper mode centered at age-11 in all five regions and a lower mode that consisted of nearly equal numbers of age-5 and age-6 fish in all regions except for Eastern Michigan where there were nearly twice as many age-5 as age-6 fish.  The age distribution, after age-4 and 5 fish were pooled and age-11 and older fish were pooled within each region for sample size reasons, differed significantly among regions (`r kPvalue(OA.chi$p.value,digits=3)`).  Variability around the age-11 mode and the relative frequency of intermediate aged (ages 7-9) fish appeared to explain much of the difference in age distribution among regions.

```{r echo=FALSE, results=show.res, message=show.msg}
bio_LW <- filterD(bio,sex!="juvenile",!is.na(wt),!is.na(tl))

## Separate regressions
lm1WAf <- lm(logW~logL,data=filterD(bio_LW,region=="West",sex=="female"))
lm1NMf <- lm(logW~logL,data=filterD(bio_LW,region=="NoMich",sex=="female"))
lm1NOf <- lm(logW~logL,data=filterD(bio_LW,region=="NoOnt",sex=="female"))
lm1SOf <- lm(logW~logL,data=filterD(bio_LW,region=="SoOnt",sex=="female"))
lm1EMf <- lm(logW~logL,data=filterD(bio_LW,region=="EastMich",sex=="female"))
lm1ALLf <- lm(logW~logL,data=filterD(bio_LW,sex=="female"))
lm1WAm <- lm(logW~logL,data=filterD(bio_LW,region=="West",sex=="male"))
lm1NMm <- lm(logW~logL,data=filterD(bio_LW,region=="NoMich",sex=="male"))
lm1NOm <- lm(logW~logL,data=filterD(bio_LW,region=="NoOnt",sex=="male"))
lm1SOm <- lm(logW~logL,data=filterD(bio_LW,region=="SoOnt",sex=="male"))
lm1EMm <- lm(logW~logL,data=filterD(bio_LW,region=="EastMich",sex=="male"))
lm1ALLm <- lm(logW~logL,data=filterD(bio_LW,sex=="male"))

lw_allregs <- data.frame(
           sex=gl(2,6,labels=c("female","male")),region=rep(c(regL,"all"),2),
           n=c(lm1WAf$df.residual+2,lm1NMf$df.residual+2,lm1NOf$df.residual+2,
               lm1SOf$df.residual+2,lm1EMf$df.residual+2,lm1ALLf$df.residual+2,
               lm1WAm$df.residual+2,lm1NMm$df.residual+2,lm1NOm$df.residual+2,
               lm1SOm$df.residual+2,lm1EMm$df.residual+2,lm1ALLm$df.residual+2),
           r2=c(rSquared(lm1WAf),rSquared(lm1NMf),rSquared(lm1NOf),
                rSquared(lm1SOf),rSquared(lm1EMf),rSquared(lm1ALLf),
                rSquared(lm1WAm),rSquared(lm1NMm),rSquared(lm1NOm),
                rSquared(lm1SOm),rSquared(lm1EMm),rSquared(lm1ALLm)),
           rbind(lm1WAf$coefficients,lm1NMf$coefficients,lm1NOf$coefficients,
                 lm1SOf$coefficients,lm1EMf$coefficients,lm1ALLf$coefficients,
                 lm1WAm$coefficients,lm1NMm$coefficients,lm1NOm$coefficients,
                 lm1SOm$coefficients,lm1EMm$coefficients,lm1ALLm$coefficients))
# reverse order of intercept and slope
lw_allregs <- lw_allregs[,c(1:4,6,5)]
names(lw_allregs)[5:6] <- c("b","log(a)")
```

```{r echo=FALSE, results=show.res, message=show.msg}
## Any differences --- no for slopes, yes for ints by region & sex
lm1 <- lm(logW~logL*region*sex,data=bio_LW)
lw_aov1 <- Anova(lm1)

## Double-Check ... any differences in slopes ... NO
bio_LW %<>% mutate(sexreg=interaction(region,sex))
lm2 <- lm(logW~logL*sexreg,data=bio_LW)
Anova(lm2)

## Get intercepts by region and sex assuming a constant slope
lm2a <- lm(logW~0+logL+sexreg,data=bio_LW)
# get common slope
lw_commonb <- coef(lm2a)[["logL"]]
## Create logW values that are adjusted for a common slope
## to a value at the meadian total length.
( mdn_tl <- median(bio_LW$tl) )
# add adjusted values to data.frame
bio_LW %<>% mutate(adj.logW=predict(lm2a,data.frame(logL=log10(mdn_tl),
                                                   sexreg=sexreg))+residuals(lm2a))
# fit two-way ANOVA with adjusted values
lm3 <- lm(adj.logW~sex*region,data=bio_LW)
# do individual contrasts ... sex within regions
lw_sexWA <- contrast(lm3,list(sex="male",region="West"),
                         list(sex="female",region="West"))
lw_sexNM <- contrast(lm3,list(sex="male",region="NoMich"),
                         list(sex="female",region="NoMich"))
lw_sexNO <- contrast(lm3,list(sex="male",region="NoOnt"),
                         list(sex="female",region="NoOnt"))
lw_sexSO <- contrast(lm3,list(sex="male",region="SoOnt"),
                         list(sex="female",region="SoOnt"))
lw_sexEM <- contrast(lm3,list(sex="male",region="EastMich"),
                         list(sex="female",region="EastMich"))
lwcomp_res_sex <- data.frame(comp=paste0("male v. female, ",regS),
                             rbind(unlist(lw_sexWA[c("Contrast","Pvalue")]),
                                   unlist(lw_sexNM[c("Contrast","Pvalue")]),
                                   unlist(lw_sexNO[c("Contrast","Pvalue")]),
                                   unlist(lw_sexSO[c("Contrast","Pvalue")]),
                                   unlist(lw_sexEM[c("Contrast","Pvalue")])))
rownames(lwcomp_res_sex) <- paste0("male v. female, ",regS)
                             

# do individual contrasts ... regions with females
lw_femWANM <- contrast(lm3,list(sex="female",region="West"),
                           list(sex="female",region="NoMich"))
lw_femWANO <- contrast(lm3,list(sex="female",region="West"),
                           list(sex="female",region="NoOnt"))
lw_femWASO <- contrast(lm3,list(sex="female",region="West"),
                           list(sex="female",region="SoOnt"))
lw_femWAEM <- contrast(lm3,list(sex="female",region="West"),
                           list(sex="female",region="EastMich"))
lw_femNMNO <- contrast(lm3,list(sex="female",region="NoMich"),
                           list(sex="female",region="NoOnt"))
lw_femNMSO <- contrast(lm3,list(sex="female",region="NoMich"),
                           list(sex="female",region="SoOnt"))
lw_femNMEM <- contrast(lm3,list(sex="female",region="NoMich"),
                           list(sex="female",region="EastMich"))
lw_femNOSO <- contrast(lm3,list(sex="female",region="NoOnt"),
                           list(sex="female",region="SoOnt"))
lw_femNOEM <- contrast(lm3,list(sex="female",region="NoOnt"),
                           list(sex="female",region="EastMich"))
lw_femSOEM <- contrast(lm3,list(sex="female",region="SoOnt"),
                           list(sex="female",region="EastMich"))
lwcomp_res_fem <- data.frame(comp=paste0("female, ",apply(combn(regS,2),MARGIN=2,FUN=paste0,collapse=" v. ")),
                             rbind(unlist(lw_femWANM[c("Contrast","Pvalue")]),
                                   unlist(lw_femWANO[c("Contrast","Pvalue")]),
                                   unlist(lw_femWASO[c("Contrast","Pvalue")]),
                                   unlist(lw_femWAEM[c("Contrast","Pvalue")]),
                                   unlist(lw_femNMNO[c("Contrast","Pvalue")]),
                                   unlist(lw_femNMSO[c("Contrast","Pvalue")]),
                                   unlist(lw_femNMEM[c("Contrast","Pvalue")]),
                                   unlist(lw_femNOSO[c("Contrast","Pvalue")]),
                                   unlist(lw_femNOEM[c("Contrast","Pvalue")]),
                                   unlist(lw_femSOEM[c("Contrast","Pvalue")])))
rownames(lwcomp_res_fem) <- paste0("female, ",apply(combn(regS,2),MARGIN=2,FUN=paste0,collapse=" v. "))
                             

# do individual contrasts ... regions with males
lw_malWANM <- contrast(lm3,list(sex="male",region="West"),
                           list(sex="male",region="NoMich"))
lw_malWANO <- contrast(lm3,list(sex="male",region="West"),
                           list(sex="male",region="NoOnt"))
lw_malWASO <- contrast(lm3,list(sex="male",region="West"),
                           list(sex="male",region="SoOnt"))
lw_malWAEM <- contrast(lm3,list(sex="male",region="West"),
                           list(sex="male",region="EastMich"))
lw_malNMNO <- contrast(lm3,list(sex="male",region="NoMich"),
                           list(sex="male",region="NoOnt"))
lw_malNMSO <- contrast(lm3,list(sex="male",region="NoMich"),
                           list(sex="male",region="SoOnt"))
lw_malNMEM <- contrast(lm3,list(sex="male",region="NoMich"),
                           list(sex="male",region="EastMich"))
lw_malNOSO <- contrast(lm3,list(sex="male",region="NoOnt"),
                           list(sex="male",region="SoOnt"))
lw_malNOEM <- contrast(lm3,list(sex="male",region="NoOnt"),
                           list(sex="male",region="EastMich"))
lw_malSOEM <- contrast(lm3,list(sex="male",region="SoOnt"),
                           list(sex="male",region="EastMich"))
lwcomp_res_mal <- data.frame(comp=paste0("male, ",apply(combn(regS,2),MARGIN=2,FUN=paste0,collapse=" v. ")),
                             rbind(unlist(lw_malWANM[c("Contrast","Pvalue")]),
                                   unlist(lw_malWANO[c("Contrast","Pvalue")]),
                                   unlist(lw_malWASO[c("Contrast","Pvalue")]),
                                   unlist(lw_malWAEM[c("Contrast","Pvalue")]),
                                   unlist(lw_malNMNO[c("Contrast","Pvalue")]),
                                   unlist(lw_malNMSO[c("Contrast","Pvalue")]),
                                   unlist(lw_malNMEM[c("Contrast","Pvalue")]),
                                   unlist(lw_malNOSO[c("Contrast","Pvalue")]),
                                   unlist(lw_malNOEM[c("Contrast","Pvalue")]),
                                   unlist(lw_malSOEM[c("Contrast","Pvalue")])))
rownames(lwcomp_res_mal) <- paste0("male, ",apply(combn(regS,2),MARGIN=2,FUN=paste0,collapse=" v. "))

lwcomp_res <- rbind(lwcomp_res_sex,lwcomp_res_fem,lwcomp_res_mal)
lwcomp_res <- cbind(lwcomp_res,adj.p=p.adjust(lwcomp_res[,"Pvalue.1"]))
lwcomp_res <- data.frame(lwcomp_res,sig=lwcomp_res[,"adj.p"]<0.05)

## Add the intercepts from the model with a common slope
lw_allregs <- cbind(lw_allregs,c(coef(lm2a)[2:6],NA,coef(lm2a)[7:11],NA))
names(lw_allregs)[ncol(lw_allregs)] <- "adj.log(a)"

## Add the predicted weight at the median tl
predWs <- 10^predict(lm2a,data.frame(logL=log10(mdn_tl),sexreg=levels(bio_LW$sexreg)))
lw_allregs <- cbind(lw_allregs,c(predWs[1:5],
                                 10^predict(lm1ALLf,data.frame(logL=log10(mdn_tl))),
                                 predWs[6:10],
                                 10^predict(lm1ALLm,data.frame(logL=log10(mdn_tl)))))
names(lw_allregs)[ncol(lw_allregs)] <- "predW"
## Clean up and print results
rownames(lw_allregs) <- NULL
```

The slopes of the weight-length relationships (Table 2) did not differ between sexes (`r kPvalue(lw_aov1["logL:sex","Pr(>F)"],digits=3)`), among regions (`r kPvalue(lw_aov1["logL:region","Pr(>F)"],digits=3)`), or due to the interaction between sex and region (`r kPvalue(lw_aov1["logL:region:sex","Pr(>F)"],digits=3)`).  The intercepts, however, differed between the sexes (`r kPvalue(lw_aov1["sex","Pr(>F)"],digits=3)`) and among the regions (`r kPvalue(lw_aov1["region","Pr(>F)"],digits=3)`), but not due to the interaction of sex and region (`r kPvalue(lw_aov1["region:sex","Pr(>F)"],digits=3)`).  Post hoc contrasts found that the intercept for females was greater than that for males for fish from Eastern Michigan (`r kPvalue(lwcomp_res["male v. female, EastMich","adj.p"],digits=3)`), but there were no differences between sexes for any other region (p > `r kPvalue(min(lwcomp_res[1:4,"adj.p"]),digits=3,include.p=FALSE)`).  Thus, females were heavier than males at all lengths only for fish from Eastern Michigan.  Post hoc contrasts showed that the intercept for females from Eastern Michigan and Southern Ontario did not significantly differ (`r kPvalue(lwcomp_res["female, SoOnt v. EastMich","adj.p"],digits=3)`), but were significantly greater than for females from all other regions (p < `r kPvalue(max(lwcomp_res[c(9,11:14),"adj.p"]),digits=3,include.p=FALSE)`) except for when Southern Ontario was compared to the Western Arm (`r kPvalue(lwcomp_res["female, West v. SoOnt","adj.p"],digits=3)`).  The intercepts for females from the Western Arm, Northern Michigan, and Northern Ontario did not significantly differ (`r kPvalue(min(lwcomp_res[c(6,7,10),"adj.p"]),digits=3)`).  Thus, females from Easter Michigan and Southern Ontario were generally heavier at the same length than females from the other regions.  The intercepts did not significantly differ among regions for male Kiyi (`r kPvalue(min(lwcomp_res[16:25,"adj.p"]),digits=3)`) which indicates that male Kiyi of the same length have statistically similar weights throughout Lake Superior. 

```{r echo=FALSE, results=show.res, fig.show='hide', warning=FALSE, message=FALSE}
lf <- read.csv("data/clean/lenfreq_all.csv") %>%
  mutate(year=factor(year))

dtype <- "lnorm"
ctype <- mixconstr(consigma="CCV")

## Trying to following 2003 year-class
lf04 <- filterD(lf,year==2004) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf04_fit <- mix(lf04,mixparam(c(100,200),10),dist=dtype,constr=ctype)
plot(lf04_fit,dist=dtype)
lf04_sum <- summary(lf04_fit)
ycl03_res <- data.frame(year=2004,age=1,
                        mntl=lf04_sum$parameters$mu[1],
                        sdtl=lf04_sum$parameters$sigma[1],
                        setl=lf04_sum$se$mu.se[1])

lf05 <- filterD(lf,year==2005) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf05_fit <- mix(lf05,mixparam(c(100,200),10),dist=dtype,constr=ctype)
plot(lf05_fit,dist=dtype)
lf05_sum <- summary(lf05_fit)
ycl03_res <- rbind(ycl03_res,c(2005,2,lf05_sum$parameters$mu[1],
                               lf05_sum$parameters$sigma[1],lf05_sum$se$mu.se[1]))

lf06 <- filterD(lf,year==2006) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf06_fit <- mix(lf06,mixparam(c(100,150,200),10),dist=dtype,constr=ctype)
plot(lf06_fit,dist=dtype)
lf06_sum <- summary(lf06_fit)
ycl03_res <- rbind(ycl03_res,c(2006,3,lf06_sum$parameters$mu[2],
                               lf06_sum$parameters$sigma[2],lf06_sum$se$mu.se[2]))

lf07 <- filterD(lf,year==2007) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf07_fit <- mix(lf07,mixparam(c(120,160,200),10),dist=dtype,constr=ctype)
plot(lf07_fit,dist=dtype)
lf07_sum <- summary(lf07_fit)
ycl03_res <- rbind(ycl03_res,c(2007,4,lf07_sum$parameters$mu[2],
                               lf07_sum$parameters$sigma[2],lf07_sum$se$mu.se[2]))

lf08 <- filterD(lf,year==2008) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf08_fit <- mix(lf08,mixparam(c(160,200),10),dist=dtype,constr=ctype)
plot(lf08_fit,dist=dtype)
lf08_sum <- summary(lf08_fit)
ycl03_res <- rbind(ycl03_res,c(2008,5,lf08_sum$parameters$mu[1],
                               lf08_sum$parameters$sigma[1],lf08_sum$se$mu.se[1]))

ycl03_res
```

```{r echo=FALSE, results=show.res, fig.show='hide', warning=FALSE, message=FALSE}
## Trying to follow the 2009 year-class
lf10 <- filterD(lf,year==2010) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf10_fit <- mix(lf10,mixparam(c(100,200),10),dist=dtype,constr=ctype)
plot(lf10_fit,dist=dtype)
lf10_sum <- summary(lf10_fit)
ycl09_res <- data.frame(year=2010,age=1,
                        mntl=lf10_sum$parameters$mu[1],
                        sdtl=lf10_sum$parameters$sigma[1],
                        setl=lf10_sum$se$mu.se[1])

lf11 <- filterD(lf,year==2011) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf11_fit <- mix(lf11,mixparam(c(130,200),10),dist=dtype,constr=ctype)
plot(lf11_fit,dist=dtype)
lf11_sum <- summary(lf11_fit)
ycl09_res <- rbind(ycl09_res,c(2011,2,lf11_sum$parameters$mu[1],
                               lf11_sum$parameters$sigma[1],lf11_sum$se$mu.se[1]))

lf12 <- filterD(lf,year==2012) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf12_fit <- mix(lf12,mixparam(c(150,200),10),dist=dtype,constr=ctype)
plot(lf12_fit,dist=dtype)
lf12_sum <- summary(lf12_fit)
ycl09_res <- rbind(ycl09_res,c(2012,3,lf12_sum$parameters$mu[1],
                               lf12_sum$parameters$sigma[1],lf12_sum$se$mu.se[1]))

lf13 <- filterD(lf,year==2013) %>%
  group_by(lcat5) %>% summarize(n=n()) %>% as.mixdata()
lf13_fit <- mix(lf13,mixparam(c(160,220),c(10,20)),dist=dtype,constr=ctype)
plot(lf13_fit,dist=dtype)
lf13_sum <- summary(lf13_fit)
ycl09_res <- rbind(ycl09_res,c(2013,4,lf13_sum$parameters$mu[1],
                               lf13_sum$parameters$sigma[1],lf13_sum$se$mu.se[1]))

ycl09_res
```
```{r echo=FALSE, results=show.res, message=show.msg}
## Combine the length frequency analysis from following year-classes
## for use later in plotting.
ycl_follow <- cbind(yrclass=rep(c(2003,2009),c(5,4)),rbind(ycl03_res,ycl09_res)) %>%
  mutate(LCI=mntl-1.96*setl,UCI=mntl+1.96*setl,
         LCV=mntl-2*sdtl,UCV=mntl+2*sdtl)
```

```{r echo=FALSE, results=show.res, message=show.msg}
lf14_ages_growth <- filterD(lf14_ages,otoAge %in% c(5,6,11))

lm_growth5 <- lm(tl~region,data=filterD(lf14_ages_growth,otoAge==5))
grow_aov5 <- Anova(lm_growth5)
grow_mc5 <- summary(glht(lm_growth5,mcp(region="Tukey")))
cld(grow_mc5)
grow5_max.sigp <- max(grow_mc5$test$pvalues[grow_mc5$test$pvalues<0.05])
grow5_min.nsigp <- min(grow_mc5$test$pvalues[grow_mc5$test$pvalues>0.05])

lm_growth6 <- lm(tl~region,data=filterD(lf14_ages_growth,otoAge==6))
grow_aov6 <- Anova(lm_growth6)
grow_mc6 <- summary(glht(lm_growth6,mcp(region="Tukey")))
cld(grow_mc6)
#grow6_max.sigp <- max(grow_mc6$test$pvalues[grow_mc6$test$pvalues<0.05])
grow6_min.nsigp <- min(grow_mc6$test$pvalues[grow_mc6$test$pvalues>0.05])

lm_growth11 <- lm(tl~region,data=filterD(lf14_ages_growth,otoAge==11))
grow_aov11 <- Anova(lm_growth11)
grow_mc11 <- summary(glht(lm_growth11,mcp(region="Tukey")))
cld(grow_mc11)
grow11_max.sigp <- max(grow_mc11$test$pvalues[grow_mc11$test$pvalues<0.05])
grow11_min.nsigp <- min(grow_mc11$test$pvalues[grow_mc11$test$pvalues>0.05])
```

The mean lengths-at-ages 5 and 11, but not age 6, differed significantly among regions (Figure 7).  Fish from Eastern Michigan were significantly longer (p < `r kPvalue(grow5_max.sigp,digits=3,include.p=FALSE)`) at age-5 than age-5 fish from other regions, which did not differ significantly (p > `r kPvalue(grow5_min.nsigp,digits=3,include.p=FALSE)`).  Age 11 fish from Northern Ontario were significantly shorter than age-11 fish from all other regions (p < `r kPvalue(grow11_max.sigp,digits=3,include.p=FALSE)`) except for Northern Michigan (`r kPvalue(grow_mc11$test$pvalues[which(names(grow_mc11$test$coefficients)=="NoOnt - NoMich")],digits=3)`), with no other significant differences at this age (p > `r kPvalue(grow11_min.nsigp,digits=3,include.p=FALSE)`).  Kiyi from the 2003 and 2009 year-classes exhibited similar growth trajectories during at least the first five years of life (Figure 7).

```{r echo=FALSE, message=show.msg, results=show.res}
cat("Results for Tables")
cat("1-Way ANOVA results for mean TL")
res_tlaov
```

```{r echo=FALSE, message=show.msg, results=show.res}
cat("1-Way ANOVA results for mean Age")
res_ageaov
```

```{r echo=FALSE, message=show.msg, results=show.res}
cat("Results from Individual Regressions")
lw_allregs %>% mutate_each(funs(round(.,3)),-sex,-region,-n)

cat("Results from Multiple Comparisons of Intercepts")
cat("Between Sexes, Within Each Region")
lwcomp_res[1:5,] %>% mutate_each(funs(round(.,4)),-comp,-sig)
cat("Between Regions for FEMALES")
lwcomp_res[6:15,] %>% mutate_each(funs(round(.,4)),-comp,-sig)
cat("Between Regions for MALES")
lwcomp_res[16:25,] %>% mutate_each(funs(round(.,4)),-comp,-sig)
```


```{r eval=makePlots, echo=FALSE, warning=FALSE, message=show.msg, results=show.res}
cat("Figures Created")
cat("Created Figure 2 - 2014 length frequency by region")
png("results/figures/Figure2_LenFreq14Reg.PNG",width=6.5,height=6.5,
    units="in",pointsize=24,family="sans",res=600)
ggplot(lf14,aes(x=tl)) +
  theme_mhist() +
  scale_x_continuous(expand=c(0.02,0),limits=c(140,280),breaks=seq(0,275,25)) +
  scale_y_continuous(expand=c(0,0),limits=c(0,1.2)) +
  geom_histogram(aes(y=..ncount..),binwidth=5,fill="gray50",color="black") +
  facet_wrap(~regionL,nrow=1,dir="v") +
  labs(x="Total Length (mm)",y="Relative Frequency")
tmp <- dev.off()
```

```{r eval=makePlots, echo=FALSE, warning=FALSE, message=show.msg, results=show.res}
cat("Created Figure 3 - 2001-14 whole lake length frequency")

tmp <- lf %>% group_by(year) %>% summarize(n=n())

lf %<>% mutate(year2=factor(mapvalues(year,levels(year),
                            paste0(tmp$year," (n=",tmp$n,")"))))

tmp <- tmp[which(tmp$year %in% ycl_follow$year),]
ycl_follow %<>% mutate(year2=factor(year),
                       year2=factor(mapvalues(year2,levels(year2),
                                    paste0(tmp$year," (n=",tmp$n,")"))))

png("results/figures/Figure3_LFProgression.PNG",width=6.5,height=9,
    units="in",pointsize=24,family="sans",res=600)
lvls <- levels(lf$year2)
ggplot(lf,aes(x=tl)) +
  theme_mhist() +
  scale_x_continuous(expand=c(0.02,0),limits=c(40,305),breaks=seq(0,350,50)) +
  scale_y_continuous(expand=c(0,0),limits=c(0,1.2)) +
  geom_histogram(aes(y=..ncount..),binwidth=5,fill="gray50",color="black") +
  facet_wrap(~year2,nrow=2,dir="v") +
  labs(x="Total Length (mm)",y="Relative Frequency") +
  geom_text(aes(y=0.9),data=data.frame(tl=110,year2=factor(lvls[4],levels=lvls)),
            label="11",size=5) +
  geom_text(aes(y=0.4),data=data.frame(tl=95,year2=factor(lvls[6],levels=lvls)),
            label="9",size=5) +
  geom_text(aes(y=0.65),data=data.frame(tl=90,year2=factor(lvls[10],levels=lvls)),
            label="5",size=5) +
  geom_point(aes(y=1.1,x=mntl),data=ycl_follow) +
  geom_segment(aes(y=1.1,yend=1.1,x=LCV,xend=UCV),data=ycl_follow)
tmp <- dev.off()
```

```{r eval=makePlots, echo=FALSE, warning=FALSE, message=show.msg, results=show.res}
cat("Created Figure 4 - Otolith age-bias plot")
png("results/figures/Figure4_OtoOtoComp.PNG",width=4.5,height=4.5,units="in",pointsize=14,family="sans",res=600)
par(mar=c(3,3,0.5,0.5),mgp=c(1.7,0.5,0),tcl=-0.2,las=1)
plot(ab_OO,show.n=TRUE,nYpos=0.025,cex.n=0.6,lwd.CI=2,col.CIsig="gray",yaxt="n",
     lwd.agree=1,xlim=c(3,20),ylim=c(-3.4,2),difference=TRUE,
     show.pts=TRUE,transparency=1/15,ylab="Second Reader",xlab="First Reader")
axis(2,seq(-3,2,1))
tmp <- dev.off()
```

```{r eval=makePlots, echo=FALSE, warning=FALSE, message=show.msg, results=show.res}
cat("Created Figure 5 - Scale-Otolith age-bias plot")
png("results/figures/Figure5_ScaleOtoComp.PNG",width=4.5,height=4.5,
    units="in",pointsize=14,family="sans",res=600)
par(mar=c(3,3,0.5,0.5),mgp=c(1.7,0.5,0),tcl=-0.2,las=1)
plot(ab_OS,show.n=TRUE,nYpos=0.025,cex.n=0.6,lwd.CI=2,col.CIsig="gray",
     lwd.agree=1,xlim=c(3,16),ylim=c(-10.5,0),difference=TRUE,yaxt="n",
     show.pts=TRUE,transparency=1/5)
axis(2,seq(-10,0,1))
axis(1,seq(4,16,2))
tmp <- dev.off()
```

```{r eval=makePlots, echo=FALSE, warning=FALSE, message=show.msg, results=show.res}
cat("Created Figure 6 - Age frequencies by region")
png("results/figures/Figure6_AgeFreq.PNG",width=6.5,height=6.5,
    units="in",pointsize=24,family="sans",res=600)
ggplot(data=lf14_ages,aes(x=otoAge)) +
  theme_kiyi() +
  scale_x_continuous(expand=c(0.02,0),limits=c(3.5,14.5),breaks=4:20) +
  scale_y_continuous(expand=c(0.05,0)) +
  geom_bar(color="black",fill="gray50") +
  facet_wrap(~regionL,ncol=1,scales="free_y") +
  labs(x="Consensus Otolith Age",y="Frequency")
tmp <- dev.off()
```

```{r eval=makePlots, echo=FALSE, warning=FALSE, message=show.msg, results=show.res}
cat("Created Figure 7 - Growth Trajectories")
png("results/figures/Figure7_Growth.PNG",width=4.5,height=4.5,
    units="in",pointsize=14,family="sans",res=600)
par(mar=c(3,3,0.5,0.5),mgp=c(1.7,0.25,0),tcl=-0.2,las=1)
growth <- lf14_ages_growth %>%
  group_by(otoAge,region) %>%
  summarize(n=n(),mntl=mean(tl),setl=se(tl)) %>%
  mutate(lci=mntl-pt(0.975,df=n-1)*setl,uci=mntl+pt(0.975,df=n-1)*setl) %>%
  mutate(jitage=otoAge+c(-0.3,-0.15,0,0.15,0.3))

with(growth,
     plotCI(jitage,mntl,ui=uci,li=lci,xlim=c(1,11.1),ylim=c(80,220),
            sfrac=0,pch=c(16,15,0,1,5),cex=0.6,xlab="Age",ylab="Total Length (mm)"))
with(filterD(ycl_follow,yrclass==2003),lines(age-0.075,mntl))
with(filterD(ycl_follow,yrclass==2003),
     plotCI(age-0.075,mntl,ui=UCI,li=LCI,sfrac=0,cex=0.1,pch=1,add=TRUE))
with(filterD(ycl_follow,yrclass==2009),lines(age+0.075,mntl,lty=2))
with(filterD(ycl_follow,yrclass==2009),
     plotCI(age+0.075,mntl,ui=UCI,li=LCI,sfrac=0,cex=0.1,pch=1,add=TRUE))
axis(1,seq(1,11,2))
legend("bottomright",regL,pch=c(16,15,0,1,5),cex=0.7,bty="n",inset=0.04)
legend("topleft",c("2003 Year-Class","2009 Year-Class"),lty=1:2,cex=0.7,bty="n")
tmp <- dev.off()
```
